# JWT를 통한 회원 인증 시스템 구현하기

2020-07-12

## JWT의 이해

JWT는 JSON Web Token의 약자로, 데이터가 JSON으로 이루어져 있는 토큰을 의미한다. 두 개체가 서로 안전하게 정보를 주고받을 수 있도록 웹 표준으로 정의된 기술이다.

### 세션 기반 인증과 토큰 기반 인증의 차이

#### 세션 기반 인증 시스템

서버가 사용자가 로그인 중임을 기억하고 있다.

세션 기반 인증 시스템에서 사용자가 로그인을 하면, 서버는 세션 저장소에 사용자의 정보를 조회하고 세션 ID를 발급한다. 발급된 ID는 주로 브라우저의 쿠키에 저장한다. 그 다음에 사용자가 다른 요청을 보낼 때마다 서버는 세션 저장소에서 세션을 조회한 후 로그인 여부를 결정하여 작업을 처리하고 응답한다. 세션 저장소는 주로 메모리, 디스크, 데이터베이스 등을 사용한다.

세션 기반 인증의 단점은 서버를 확장하기가 번거로워질 수 있다는 점이다. 만약 서버의 인스턴스가 여러 개가 된다면, 모든 서버끼리 같은 세션을 공유해야 하므로 세션 전용 데이터베이스를 만들어야 할 뿐 아니라 신경 써야 할 것도 많다.

#### 토큰 기반 인증 시스템

토근은 로그인 이후 서버가 만들어 주는 문자열이다. 해당 문자열 안에는 사용자의 로그인 정보가 들어 있고, 해당 정보가 서버에서 발급되었음을 증명하는 서명이 들어 있다. 서명 데이터는 해싱 알고리즘을 통해 만들어지는데, 주로 HMAC SHA256 혹은 RSA SHA256 알고리즘이 사용된다.

서버에서 만들어 준 토큰은 서명이 있기 때문에 무결성(정보가 변경되거나 위조되지 않았음을 의미하는 성질)이 보장된다. 사용자가 로그인을 하면 서버에서 사용자에게 해당 사용자의 정보를 지니고 있는 토큰을 발급해 주고, 추후 사용자가 다른 API를 요청하게 될 때 발급받은 토큰과 함께 요청하게 된다. 그러면 서버는 해당 토큰이 유효한지 검사하고, 결과에 따라 작업을 처리하고 응답한다.

토큰 기반 인증 시스템의 장점은 서버에서 사용자 로그인 정보를 기억하기 위해 사용하는 리소스가 적다는 것이다. 사용자 쪽에서 로그인 상태를 지닌 토큰을 가지고 있으므로 서버의 확장성이 매우 높다. 서버의 인스턴스가 여러 개로 늘어나도 서버끼리 사용자의 로그인 상태를 공유하고 있을 필요가 없다.

여기서는 구현하기 간편하고, 사용자들의 인증 상태를 관리하기 편한 토큰 기반 인증 시스템을 사용한다.

## User 스키마/모델 만들기

비밀번호를 DB에 저장 시 플레인 텍스트로 저장하면 보안상 위험하다. 따라서 단방향 해싱 함수를 지원해 주는 bcrypt 라이브러리를 사용하여 저장할 것이다.

```
yarn add bcrypt
```

### 모델 메서드 만들기

모델 메서드는 모델에서 사용할 수 있는 함수를 의미하며, 두 가지 종류가 있다. 첫 번째는 인스턴스 메서드로, 모델을 통해 만든 문서 인스턴스에서 사용할 수 있는 함수를 의미한다.

```javascript
const user = new User({ username: 'ydhwa' });
user.setPassword('mypass1234');
```

두 번째는 스태틱 메서드로, 모델에서 바로 사용할 수 있는 함수를 의미한다.

```javascript
const user = User.findByUsername('ydhwa');
```

인스턴스 메서드 작성 시 화살표 함수가 아닌 function 키워드를 사용하여 구현해야 한다. 함수 내부에서 this에 접근해야 하기 때문이다. 여기서 this는 문서 인스턴스를 가리킨다. 화살표 함수를 사용하면 this는 문서 인스턴스를 가리키지 못하게 된다.

스태틱 함수에서의 this는 모델을 가리킨다.

## 회원 인증 API 만들기

클라이언트에서 사용자 로그인 정보를 지니고 있을 수 있도록 서버에서 토큰을 발급한다. JWT 토큰을 만들기 위해서는 jsonwebtoken이라는 모듈을 설치한다.

```
yarn add jsonwebtoken
```

### 비밀키 설정하기

macOS/리눅스 사용 시 터미널에 다음 명령어 입력하여 랜덤 문자열을 복사해서 .env 파일에 저장(JWT_SECRET).

```
openssl rand -hex 64
```

이 비밀키는 나중에 JWT 토큰의 서명을 만드는 과정에서 사용된다. 비밀키는 외부에 공개되면 안 된다.

### 토큰 발급 및 검증하기

사용자가 브라우저에서 토큰을 사용할 때는 주로 두 가지 방법을 사용한다. 첫 번째는 브라우저의 localStorage 혹은 sessionStorage에 담아서 사용하는 방법이고, 두 번째는 브라우저의 쿠키에 담아서 사용하는 방법이다.

브라우저의 localStorage 혹은 sessionStorage에 토큰을 담으면 사용하기가 매우 편리하고 구현하기도 쉽다. 하지만 만약 누군가가 페이지에 악성 스크립트를 삽입한다면 쉽게 토큰을 탈취할 수 있다.(이러한 공격을 XSS(Cross Site Scripting)라고 한다.)

쿠키에 담아도 같은 문제가 발생할 수 있지만, httpOnly라는 속성을 활성화하면 자바스크립트를 통해 쿠키를 조회할 수 없으므로 악성 스크립트로부터 안전하다. 그 대신 CSRF(Cross Site Request Forgery)라는 공격에 취약해질 수 있다. 이 공격은 토큰을 쿠키에 담으면 사용자가 서버로 요청을 할 때마다 무조건 토큰이 함께 전달되는 점을 이용해서 사용자가 모르게 원하지 않는 API 요청을 하게 만든다.

단, CSRF는 CSRF 토큰 사용 및 Referer 검증 등의 방식으로 제대로 막을 수 있는 반면, XSS는 보안장치를 적용해 놓아도 개발자가 놓칠 수 있는 다양한 취약점을 통해 공격을 받을 수 있다.

토큰을 검증하는 작업은 미들웨어로 만들어 처리한다. 미들웨어를 적용하는 작업은 app에 router 미들웨어를 적용하기 전에 이루어져야 한다.

```javascript
{
  _id: '5f0b0df3b4547f9844f9b010',
  username: 'ydhwa',
  iat: 1594561977,
  exp: 1595166777
}
```

미들웨어를 통해 토큰이 해석된 이후에 위와 같은 결과물이 출력되는데, 여기서 iat 값은 이 토큰이 언제 만들어졌는지 알려 주는 값이고, exp 값은 언제 만료되는지 알려 주는 값이다.

## posts API에 회원 인증 시스템 도입하기

### 스키마 수정하기

Post 스키마 안에 사용자의 id와 username을 전부 넣어 주어야 한다. 이후 posts 컬렉션을 비운다.

## username/tags로 포스트 필터링하기

## 정리
